<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FX Risk Size Calculator (Manual Price)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --text:#e8eefc;
      --muted:#9fb0d0;
      --accent:#6aa7ff;
      --ok:#64d39a;
      --warn:#ffcf6a;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 600px at 20% 0%, #142041 0%, var(--bg) 55%) fixed;
      color: var(--text);
    }
    .wrap{ max-width: 980px; margin: 28px auto; padding: 0 16px 40px; }
    header{ display:flex; align-items:flex-end; justify-content:space-between; gap:16px; margin-bottom: 18px; }
    h1{ font-size: 20px; margin:0; letter-spacing:.2px; }
    .sub{ margin: 6px 0 0; color: var(--muted); font-size: 13px; line-height: 1.35; max-width: 760px; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; padding: 16px; }
    @media (max-width: 820px){ .grid{ grid-template-columns: 1fr; } header{ flex-direction:column; align-items:flex-start; } }
    .section{
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px;
      padding: 14px;
    }
    .section h2{
      font-size: 13px; margin:0 0 10px; color: var(--muted);
      font-weight: 600; text-transform: uppercase; letter-spacing:.08em;
    }
    label{ display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 520px){ .row{ grid-template-columns:1fr; } }
    input, select, button{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(10,14,24,.55);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    input::placeholder{ color: rgba(159,176,208,.55); }
    input:focus, select:focus{
      border-color: rgba(106,167,255,.55);
      box-shadow: 0 0 0 3px rgba(106,167,255,.15);
    }
    .btnbar{ display:flex; gap: 10px; margin-top: 12px; }
    button{
      cursor:pointer;
      font-weight: 650;
      letter-spacing:.2px;
      border: 1px solid rgba(106,167,255,.55);
      background: linear-gradient(180deg, rgba(106,167,255,.30), rgba(106,167,255,.14));
    }
    button.secondary{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-weight: 600;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }
    .pill strong{ color: var(--text); font-family: var(--mono); font-size: 12px; font-weight: 700; }
    .meta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .status{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .status.ok{ border-color: rgba(100,211,154,.35); }
    .status.warn{ border-color: rgba(255,207,106,.35); }
    .mono{ font-family: var(--mono); }
    .results{
      padding: 16px;
      border-top: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.16);
    }
    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
    }
    td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size: 13px;
      vertical-align: top;
    }
    tr:last-child td{ border-bottom:none; }
    td:first-child{ color: var(--muted); width: 52%; }
    .right{ text-align:right; font-family: var(--mono); }
    .foot{ margin-top: 10px; color: var(--muted); font-size: 12px; line-height: 1.35; }
    .small{ font-size: 12px; color: var(--muted); margin-top: 6px; }
    .hide{ display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>FX Risk Size Calculator (Manual Price)</h1>
        <p class="sub">
          Manual price. Outputs a single recommended position size (units) based on risk and leverage/margin constraints.
          Assumes <span class="mono">Account Currency = USD</span>.
        </p>
      </div>
      <div class="meta">
        <span class="pill">Pair: <strong id="pairOut">EURUSD</strong></span>
        <span class="pill">Pip Size: <strong id="pipOut">0.0001</strong></span>
        <span class="pill">Stop (pips): <strong id="stopPipsLive">—</strong></span>
      </div>
    </header>

    <div class="card">
      <div class="grid">
        <div class="section">
          <h2>Inputs</h2>

          <label for="pair">Major Pair</label>
          <select id="pair">
            <option value="EURUSD">EURUSD</option>
            <option value="GBPUSD">GBPUSD</option>
            <option value="USDJPY">USDJPY</option>
            <option value="USDCHF">USDCHF</option>
            <option value="USDCAD">USDCAD</option>
            <option value="AUDUSD">AUDUSD</option>
            <option value="NZDUSD">NZDUSD</option>
          </select>

          <label for="price">Current Price (Entry)</label>
          <input id="price" type="number" min="0" step="0.00001" placeholder="e.g., 1.08540 (or 156.320 for JPY pairs)" />

          <label for="stopMode">Stop Input Mode</label>
          <select id="stopMode">
            <option value="pips">Stop in pips</option>
            <option value="price">Stop at a specific price</option>
          </select>

          <div class="row" id="rowStopPips">
            <div>
              <label for="stopPips">Stop-Loss (pips)</label>
              <input id="stopPips" type="number" min="0" step="0.1" placeholder="10" />
            </div>
            <div>
              <label>Computed Stop (pips)</label>
              <input id="stopPipsComputedA" type="text" disabled value="—" />
            </div>
          </div>

          <div class="row hide" id="rowStopPrice">
            <div>
              <label for="stopPrice">Stop Price</label>
              <input id="stopPrice" type="number" min="0" step="0.00001" placeholder="e.g., 1.08440" />
            </div>
            <div>
              <label>Computed Stop (pips)</label>
              <input id="stopPipsComputedB" type="text" disabled value="—" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="balance">Account Balance (USD)</label>
              <input id="balance" type="number" min="0" step="0.01" placeholder="0.00" />
            </div>
            <div>
              <label for="riskPct">Risk %</label>
              <input id="riskPct" type="number" min="0" step="0.01" placeholder="1.00" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="leverage">Leverage (e.g., 30 = 30:1)</label>
              <input id="leverage" type="number" min="1" step="1" placeholder="30" />
            </div>
            <div>
              <label>&nbsp;</label>
              <input type="text" disabled value=" " />
            </div>
          </div>

          <div class="btnbar">
            <button id="btnCalc">Calculate</button>
            <button class="secondary" id="btnReset">Reset</button>
          </div>

          <div class="small">
            Note: EURUSD pip size is always <span class="mono">0.0001</span>. It only changes for JPY pairs.
          </div>
        </div>

        <div class="section">
          <h2>Status</h2>
          <div id="statusBox" class="status">Enter price + inputs, then calculate.</div>
          <div class="foot" id="modeNote"></div>
        </div>
      </div>

      <div class="results">
        <table>
          <tr><td><strong>Recommended Position Size (Units)</strong></td><td class="right" id="recUnitsOut">—</td></tr>
          <tr><td>Risk Amount (USD)</td><td class="right" id="riskAmtOut">—</td></tr>
          <tr><td>Stop Distance (pips)</td><td class="right" id="stopOut">—</td></tr>
          <tr><td>Pip Size</td><td class="right" id="pipSizeOut">—</td></tr>
          <tr><td>Pip Value per 1 Unit (USD)</td><td class="right" id="pipValOut">—</td></tr>
          <tr><td>Risk-based Units</td><td class="right" id="riskUnitsOut">—</td></tr>
          <tr><td>Max Units Allowed by Leverage</td><td class="right" id="maxUnitsOut">—</td></tr>
          <tr><td>Margin Required (USD) for Recommended Size</td><td class="right" id="marginOut">—</td></tr>
        </table>
        <div class="foot" id="warnings"></div>
      </div>
    </div>
  </div>

  <script>
    const els = {
      pair: document.getElementById("pair"),
      price: document.getElementById("price"),

      stopMode: document.getElementById("stopMode"),
      rowStopPips: document.getElementById("rowStopPips"),
      rowStopPrice: document.getElementById("rowStopPrice"),
      stopPips: document.getElementById("stopPips"),
      stopPrice: document.getElementById("stopPrice"),
      stopPipsComputedA: document.getElementById("stopPipsComputedA"),
      stopPipsComputedB: document.getElementById("stopPipsComputedB"),
      stopPipsLive: document.getElementById("stopPipsLive"),

      balance: document.getElementById("balance"),
      riskPct: document.getElementById("riskPct"),
      leverage: document.getElementById("leverage"),

      btnCalc: document.getElementById("btnCalc"),
      btnReset: document.getElementById("btnReset"),

      statusBox: document.getElementById("statusBox"),
      modeNote: document.getElementById("modeNote"),

      pairOut: document.getElementById("pairOut"),
      pipOut: document.getElementById("pipOut"),

      recUnitsOut: document.getElementById("recUnitsOut"),
      riskAmtOut: document.getElementById("riskAmtOut"),
      stopOut: document.getElementById("stopOut"),
      pipSizeOut: document.getElementById("pipSizeOut"),
      pipValOut: document.getElementById("pipValOut"),
      riskUnitsOut: document.getElementById("riskUnitsOut"),
      maxUnitsOut: document.getElementById("maxUnitsOut"),
      marginOut: document.getElementById("marginOut"),
      warnings: document.getElementById("warnings"),
    };

    function fmt(n, d=2){
      if (!isFinite(n)) return "—";
      return Number(n).toLocaleString(undefined, { maximumFractionDigits: d, minimumFractionDigits: d });
    }
    function fmtFixed(n, d=1){
      if (!isFinite(n)) return "—";
      return Number(n).toFixed(d);
    }
    function setStatus(msg, kind=""){
      els.statusBox.className = "status" + (kind ? " " + kind : "");
      els.statusBox.textContent = msg;
    }

    function pipSizeForPair(pair){ return pair.endsWith("JPY") ? 0.01 : 0.0001; }

    // Account Currency = USD
    function pipValuePerUnitUSD(pair, price){
      const base = pair.slice(0,3);
      const quote = pair.slice(3,6);
      const pip = pipSizeForPair(pair);

      // Quote USD -> pip value per 1 unit is pip size in USD
      if (quote === "USD") return pip;

      // Base USD -> pip is in quote currency; convert to USD by dividing by price (USDXXX)
      if (base === "USD") return pip / price;

      return pip; // not used here
    }

    function notionalUSD(pair, units, price){
      const base = pair.slice(0,3);
      const quote = pair.slice(3,6);

      // Quote USD pairs -> units * price
      if (quote === "USD") return units * price;

      // Base USD pairs -> units are USD
      if (base === "USD") return units;

      return units * price;
    }

    function resetOutputs(){
      els.recUnitsOut.textContent = "—";
      els.riskAmtOut.textContent = "—";
      els.stopOut.textContent = "—";
      els.pipSizeOut.textContent = "—";
      els.pipValOut.textContent = "—";
      els.riskUnitsOut.textContent = "—";
      els.maxUnitsOut.textContent = "—";
      els.marginOut.textContent = "—";
      els.warnings.innerHTML = "";
      els.modeNote.textContent = "";
    }

    function updatePairMeta(){
      const pair = els.pair.value;
      const pip = pipSizeForPair(pair);
      els.pairOut.textContent = pair;
      els.pipOut.textContent = pip.toString();
      els.pipSizeOut.textContent = pip.toString();

      els.price.step = pair.endsWith("JPY") ? "0.001" : "0.00001";
      els.price.placeholder = pair.endsWith("JPY") ? "e.g., 156.320" : "e.g., 1.08540";

      els.stopPrice.step = els.price.step;
      els.stopPrice.placeholder = pair.endsWith("JPY") ? "e.g., 156.220" : "e.g., 1.08440";
    }

    function computeStopPips(){
      const pair = els.pair.value;
      const pipSize = pipSizeForPair(pair);

      const entry = Number(els.price.value);
      const mode = els.stopMode.value;

      let stopPips = NaN;

      if (mode === "pips") {
        stopPips = Number(els.stopPips.value);
      } else {
        const stopPrice = Number(els.stopPrice.value);
        if (entry > 0 && stopPrice > 0) {
          stopPips = Math.abs(entry - stopPrice) / pipSize;
        }
      }

      const display = (isFinite(stopPips) && stopPips > 0) ? fmtFixed(stopPips, 1) : "—";
      els.stopPipsComputedA.value = display;
      els.stopPipsComputedB.value = display;
      els.stopPipsLive.textContent = display;

      return stopPips;
    }

    function syncStopModeUI(){
      const mode = els.stopMode.value;
      if (mode === "pips") {
        els.rowStopPips.classList.remove("hide");
        els.rowStopPrice.classList.add("hide");
      } else {
        els.rowStopPips.classList.add("hide");
        els.rowStopPrice.classList.remove("hide");
      }
      computeStopPips();
    }

    function calc(){
      const pair = els.pair.value;
      const price = Number(els.price.value);
      const balance = Number(els.balance.value);
      const riskPct = Number(els.riskPct.value);
      const leverage = Number(els.leverage.value);
      const stopPips = computeStopPips();

      resetOutputs();

      if (!(price > 0)) { setStatus("Enter current price (entry).", "warn"); return; }
      if (!(balance > 0)) { setStatus("Enter account balance.", "warn"); return; }
      if (!(riskPct > 0)) { setStatus("Enter risk %.", "warn"); return; }
      if (!(leverage > 0)) { setStatus("Enter leverage.", "warn"); return; }
      if (!(stopPips > 0) || !isFinite(stopPips)) { setStatus("Enter a valid stop (pips or stop price).", "warn"); return; }

      const pipSize = pipSizeForPair(pair);
      const pipValUnit = pipValuePerUnitUSD(pair, price);

      const riskAmt = balance * (riskPct / 100);

      // Risk-based units
      const riskUnits = riskAmt / (stopPips * pipValUnit);

      // Max units by leverage (uses full balance as margin capacity)
      const base = pair.slice(0,3);
      const quote = pair.slice(3,6);
      let maxUnits;
      if (quote === "USD") {
        maxUnits = (balance * leverage) / price;
      } else if (base === "USD") {
        maxUnits = balance * leverage;
      } else {
        maxUnits = (balance * leverage) / price;
      }

      // Recommended = smaller of risk-based vs margin-allowed
      const recUnits = Math.min(riskUnits, maxUnits);

      // Margin required for recommended size
      const notional = notionalUSD(pair, recUnits, price);
      const marginReq = notional / leverage;

      // Output
      els.recUnitsOut.textContent = fmt(recUnits, 0);
      els.riskAmtOut.textContent = "$" + fmt(riskAmt, 2);
      els.stopOut.textContent = fmtFixed(stopPips, 1);
      els.pipSizeOut.textContent = pipSize.toString();
      els.pipValOut.textContent = "$" + fmt(pipValUnit, 6);
      els.riskUnitsOut.textContent = fmt(riskUnits, 0);
      els.maxUnitsOut.textContent = fmt(maxUnits, 0);
      els.marginOut.textContent = "$" + fmt(marginReq, 2);

      const isMarginLimited = recUnits < riskUnits - 1e-6;

      if (isMarginLimited) {
        setStatus("Calculated: margin-limited (leverage constraint).", "warn");
        els.modeNote.textContent = "Recommended size was capped by leverage/margin. Increase leverage, reduce risk, or tighten stop to align risk size with margin limits.";
      } else {
        setStatus("Calculated: risk-limited (your risk settings).", "ok");
        els.modeNote.textContent = "Recommended size is determined by your risk% and stop distance.";
      }
    }

    // Events
    els.pair.addEventListener("change", () => {
      updatePairMeta();
      resetOutputs();
      computeStopPips();
      setStatus("Enter price + inputs, then calculate.", "");
    });

    els.stopMode.addEventListener("change", () => {
      syncStopModeUI();
      resetOutputs();
      setStatus("Stop mode updated.", "");
    });

    ["input","change"].forEach(evt => {
      els.price.addEventListener(evt, computeStopPips);
      els.stopPips.addEventListener(evt, computeStopPips);
      els.stopPrice.addEventListener(evt, computeStopPips);
    });

    els.btnCalc.addEventListener("click", calc);

    els.btnReset.addEventListener("click", () => {
      els.price.value = "";
      els.balance.value = "";
      els.riskPct.value = "";
      els.leverage.value = "";
      els.stopPips.value = "";
      els.stopPrice.value = "";
      resetOutputs();
      computeStopPips();
      setStatus("Reset.", "");
    });

    // Init
    updatePairMeta();
    syncStopModeUI();
    resetOutputs();
  </script>
</body>
</html>
